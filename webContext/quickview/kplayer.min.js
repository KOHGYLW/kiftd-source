var tReq;var tTimer;var pingInt;$(function(){window.onresize=function(){showCloseBtn()};pingInt=setInterval("ping()",60000);var fileId=getFileId();$.ajax({url:"homeController/playVideo.ajax",type:"POST",dataType:"text",data:{fileId:fileId},success:function(result){if(result!="ERROR"){f=eval("("+result+")");$("#vname").text(f.fileName);$("#vcreator").text(f.fileCreator);$("#vcdate").text(f.fileCreationDate);var fileSizeToInt=parseInt(f.fileSize);if(fileSizeToInt==0){$("#vsize").text("<1 MB")}else{if(fileSizeToInt<1000){$("#vsize").text(fileSizeToInt+" MB")}else{if(fileSizeToInt<1024000){$("#vsize").text((fileSizeToInt/1024).toFixed(2)+" GB")}else{$("#vsize").text((fileSizeToInt/1048576).toFixed(2)+" TB")}}}if(f.needEncode=="N"){playVideo()}else{$("#playerMassage").html("<h2>播放器正在努力解码中...</h2><h3>已完成：<span id='transcodeProgress'>0</span>%</h3><p class='text-muted'>提示：该视频需解码后播放，请耐心等待！</p>");doTranscode()}}else{alert("错误：无法定位要预览的文件或该操作未被授权。");reMainPage()}},error:function(){alert("错误：请求失败，请刷新重试。");reMainPage()}})});function getFileId(){var a=location.search;if(a.indexOf("?")!=-1){var b=a.substr(1);strs=b.split("=");return strs[1]}return""}function playVideo(){$("#playerbox").html("<video id='kiftplayer' class='video-js col-md-12' controls preload='auto' height='500'><source src='resourceController/getResource/"+f.fileId+"' type='video/mp4'></video>");createComponent();document.body.addEventListener("keydown",function(b){if(b.keyCode==39){play_fast_next()}else{if(b.keyCode==37){play_fast_back()}else{if(b.keyCode==32){var c=document.getElementsByClassName("vjs-play-control")[0].innerText;if(c=="Play"){videoPlayer.play()}else{if(c=="Pause"){videoPlayer.pause()}}}}}});var a=videojs("kiftplayer",{preload:"auto",playbackRates:[0.5,1,1.25,1.5,2],controlBar:{children:["backwardButton","playToggle","FastForwardButton","volumePanel","currentTimeDisplay","timeDivider","durationDisplay","progressControl","liveDisplay","seekToLive","remainingTimeDisplay","customControlSpacer","chaptersButton","descriptionsButton","subsCapsButton","audioTrackButton","fullscreenToggle","theaterModeButton","playbackRateMenuButton"]}});videoPlayer=a;a.ready(function(){this.play()})}function createComponent(){var d=videojs.getComponent("Component");var a=videojs.extend(d,{constructor:function(g,e){d.apply(this,arguments);this.on("click",this.clickfastForward)},createEl:function(){var e=videojs.dom.createEl("button",{title:"快进十秒",style:"font-size:2em;width: 2em;",className:"vjs-icon-next-item vjs-fast-forward-button vjs-control vjs-button",innerHTML:'<span aria-hidden="true" class="vjs-icon-placeholder"></span><span class="vjs-control-text" aria-live="polite">快进</span>'});return e},clickfastForward:function(){play_fast_next()}});videojs.registerComponent("FastForwardButton",a);var c=videojs.extend(d,{constructor:function(g,e){d.apply(this,arguments);this.on("click",this.clickBackward)},createEl:function(){var e=videojs.dom.createEl("button",{title:"快退十秒",style:"font-size:2em;width: 2em;",className:"vjs-icon-previous-item vjs-fast-replay-button vjs-control vjs-button",innerHTML:'<span aria-hidden="true" class="vjs-icon-placeholder"></span><span class="vjs-control-text" aria-live="polite">快退</span>'});return e},clickBackward:function(){play_fast_back()}});videojs.registerComponent("backwardButton",c);var b=videojs.extend(d,{constructor:function(g,e){d.apply(this,arguments);this.on("click",this.clickTheaterMode)},createEl:function(){var e=videojs.dom.createEl("button",{title:"网页全屏",style:"font-size:1.63em;width: 1em;",className:"vjs-icon-square vjs-control vjs-button theater-mode",innerHTML:'<span aria-hidden="true" class="vjs-icon-placeholder"></span><span class="vjs-control-text" aria-live="polite">网页全屏</span>'});return e},clickTheaterMode:function(){play_theaterMode()}});videojs.registerComponent("theaterModeButton",b)}var videoPlayer;function play_fast_next(){videoPlayer.currentTime(videoPlayer.currentTime()+5)}function play_fast_back(){videoPlayer.currentTime(videoPlayer.currentTime()-5)}var isTheaterMode=false;function play_theaterMode(){var d=videoPlayer.videoWidth();var b=videoPlayer.videoHeight();var a=document.body.clientHeight;var c=document.body.clientWidth;if(isTheaterMode){document.getElementById("kiftplayer").style.width=1110+"px";document.getElementById("kiftplayer").style.height=500+"px";document.getElementsByClassName("container")[0].style.marginLeft="auto";document.getElementsByClassName("container")[0].style.marginRight="auto";document.getElementsByClassName("container")[0].style.paddingLeft="15px";document.getElementsByClassName("container")[0].style.paddingRight="15px";document.body.style.backgroundColor="#FFFFFF";document.body.style.overflowX="auto";window.scrollTo(0,0);isTheaterMode=false}else{document.getElementById("kiftplayer").style.width=(c-35)+"px";document.getElementById("kiftplayer").style.height=(a-5)+"px";document.getElementsByClassName("container")[0].style.marginLeft="0px";document.getElementsByClassName("container")[0].style.marginRight="0px";document.getElementsByClassName("container")[0].style.paddingLeft="0px";document.getElementsByClassName("container")[0].style.paddingRight="0px";document.body.style.backgroundColor="#000";document.body.style.overflowX="hidden";window.scrollTo(document.body.scrollWidth,document.body.scrollHeight);isTheaterMode=true}}function reMainPage(){if(tReq!=null){tReq.abort()}if(tTimer!=null){window.clearTimeout(tTimer)}window.opener=null;window.open("","_self");window.close()}function doTranscode(){tReq=$.ajax({url:"resourceController/getVideoTranscodeStatus.ajax",type:"POST",dataType:"text",data:{fileId:f.fileId},success:function(a){if(a=="FIN"){playVideo()}else{if(a=="ERROR"){alert("错误：请求失败，请刷新重试。");reMainPage()}else{$("#transcodeProgress").text(a);tTimer=setTimeout("doTranscode()",500)}}},error:function(){alert("错误：请求失败，请刷新重试。");reMainPage()}})}function showCloseBtn(){var a=$(window).width();if(a<450){$("#closeBtn").addClass("hidden")}else{$("#closeBtn").removeClass("hidden")}}function ping(){$.ajax({url:"homeController/ping.ajax",type:"POST",dataType:"text",data:{},success:function(a){if(a!="pong"){window.clearInterval(pingInt)}},error:function(){window.clearInterval(pingInt)}})};